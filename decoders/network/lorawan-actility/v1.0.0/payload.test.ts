import { readFileSync } from "fs";
import { join } from "path";
import * as ts from "typescript";
import { beforeEach, describe, expect, test } from "vitest";

import { DataToSend } from "@tago-io/sdk/lib/types";

const file = readFileSync(join(__dirname, "./payload.js"));
const transpiledCode = ts.transpile(file.toString());

let payload: DataToSend[] = [];

describe("New Actility Payload Validation", () => {
  beforeEach(() => {
    payload = [
      {
        variable: "actility_payload",
        value:
          '{"deviceEUI":"1122334455667738","time":"2022-09-07T03:33:27.249Z","customerId":"100009247","modelCfg":"0","dxProfileId":"community-api","coordinates":[103.89371486839646,1.3179848438126165,0],"age":0,"validityState":"NEW","horizontalAccuracy":0,"incomingSubscriberId":"100009247","processedFeed":{"SF":7,"deviceProfileId":"ABEEWAY/MICRO","payloadEncoded":"03485c84aa01abcd04303136c8abcd04303135c5abcd04303132c3","sequenceNumber":33308,"receptionTime":"2022-09-07T03:33:27.249Z","dynamicMotionState":"STATIC","temperatureMeasure":22.77647,"processedPacket":{"SNR":11.75,"RSSI":-36,"baseStationId":"10000708","antennaCoordinates":[103.89371486839646,1.3179848438126165]},"port":18},"rawPosition":{"rawPositionType":"RawPositionByBleSolver","coordinates":[103.89371464580393,1.3179839628913457],"age":8,"horizontalAccuracy":2,"bssidCount":3,"beaconIdData":[{"rssi":-56,"beaconId":"AB-CD-04-30-31-36"},{"rssi":-59,"beaconId":"AB-CD-04-30-31-35"},{"rssi":-61,"beaconId":"AB-CD-04-30-31-32"}],"beaconFormat":"BEACON_ID","floor_number":4,"room_name":"443"},"resolvedTracker":{"firmwareVersion":"2.3.1","bleFirmwareVersion":"3.3.3","messageType":"POSITION_MESSAGE","eventType":"UNKNOWN","shutdownCause":"UNKNOWN","trackingMode":"PERMANENT_TRACKING","gpsScanMode":"STANDARD","sensorMode":"UNKNOWN","periodicPositionInterval":3600,"batteryLevel":92,"batteryStatus":"OPERATING","sosFlag":false,"activityCount":-1,"trackingUlPeriod":16,"loralivePeriod":600,"energyStatusPeriod":0,"geolocSensorProfile":"BGPS_ONLY","oneshotGeolocMethod":"GPS","extAntennaProfile":"PRINTED","motionStartEndNbTx":1,"gpsTimeout":240,"xgpsTimeout":45,"gpsEHPE":1,"gpsConvergence":12,"configFlags":{"framePendingMechanism":true,"buttonPressToTurnDeviceOff":true,"doubleClickIsSosModeOrAlert":true,"downlinkSetParameterConfirmation":true,"wifiPayloadWithNoCypher":true,"bleAdvertisingAtStart":true,"selectWifiScanOrGeolocStartMessage":false,"ledBlinkWithGpsFix":false,"startMotionEventUplink":false,"endMotionEventUplink":false,"otaJoinWhenLeavingModeOff":false,"rejectAsymmetricBlePairing":false,"enableLongWifiPayload":false,"collectionLongReport":false,"autoStart":false},"transmitStrat":"CUSTOM_STRATEGY","bleBeaconCount":4,"bleBeaconTimeout":2,"gpsStandbyTimeout":28800,"confirmedUlBitmap":0,"confirmedUlRetry":3,"motionSensitivity":1,"shockDetection":0,"periodicActivityPeriod":0,"motionDuration":180,"bleRssiFilter":-85,"temperatureHigh":255,"temperatureLow":255,"temperatureAction":"NO_ACTION","bleBond":"UNKNOWN","transmitStratCustom":{"ADREnabled":false,"transmissionType":"SINGLE","firstTransmissionDatarateDistribution":"RANDOM","secondTransmissionDatarateDistribution":"RANDOM","firstTransmissionDatarate":{"dr0":false,"dr1":false,"dr2":true,"dr3":false,"dr4":false,"dr5":false,"dr6":false,"dr7":false},"secondTransmissionDatarate":{"dr0":false,"dr1":false,"dr2":false,"dr3":false,"dr4":false,"dr5":false,"dr6":false,"dr7":false}},"batteryCapacity":4294967295,"reedSwitchConfiguration":"DISABLE_REED_SWITCH","collectionScanType":"NO_COLLECTION_SCAN","collectionBLEFilterType":"NO_FILTER","collectionBLEFilterMain1":0,"collectionBLEFilterMain2":0,"collectionBLEFilterSecValue":0,"collectionBLEFilterSecMask":0,"collectionNbEntry":20,"networkTimeoutCheck":432000,"networkTimeoutReset":172800,"gnssConstellation":"GPS_GLONASS_GALILEO"},"uplinkPayload":{"messageType":"POSITION_MESSAGE","age":8,"trackingMode":"PERMANENT_TRACKING","batteryLevel":92,"batteryStatus":"OPERATING","ackToken":10,"rawPositionType":"BLE_BEACON_SCAN_SHORT_ID","periodicPosition":false,"temperatureMeasure":22.8,"sosFlag":0,"appState":1,"dynamicMotionState":"STATIC","onDemand":false,"payload":"03485c84aa01abcd04303136c8abcd04303135c5abcd04303132c3","deviceConfiguration":{"mode":"PERMANENT_TRACKING"},"bleBeaconIds":[{"beaconId":"ab-cd-04-30-31-36","rssi":-56},{"beaconId":"ab-cd-04-30-31-35","rssi":-59},{"beaconId":"ab-cd-04-30-31-32","rssi":-61}]},"resolvedTrackerParameters":{"mode":"PERMANENT_TRACKING","defaultProfile":"UNKNOWN","dynamicProfile":"Unknown","geolocSensorProfile":"BGPS_ONLY","oneshotGeolocMethod":"GPS","extAntennaProfile":"PRINTED","motionStartEndNbTx":1,"gpsTimeout":240,"configFlags":{"framePendingMechanism":true,"buttonPressToTurnDeviceOff":true,"doubleClickIsSosModeOrAlert":true,"downlinkSetParameterConfirmation":true,"wifiPayloadWithNoCypher":true,"bleAdvertisingAtStart":true,"selectWifiScanOrGeolocStartMessage":false,"ledBlinkWithGpsFix":false,"startMotionEventUplink":false,"endMotionEventUplink":false,"otaJoinWhenLeavingModeOff":false,"rejectAsymmetricBlePairing":false,"enableLongWifiPayload":false,"collectionLongReport":false,"autoStart":false},"firmwareVersion":"2.3.1","bleFirmwareVersion":"3.3.3","loralivePeriod":600,"periodicPositionInterval":3600,"trackingUlPeriod":16,"transmitStrat":"CUSTOM_STRATEGY","transmitStratCustom":{"adrEnabled":0,"transmissionType":"SINGLE","firstTransmissionDatarateDistribution":"RANDOM","secondTransmissionDatarateDistribution":"RANDOM","firstTransmissionDatarate":{"dr0":0,"dr1":0,"dr2":1,"dr3":0,"dr4":0,"dr5":0,"dr6":0,"dr7":0},"secondTransmissionDatarate":{"dr0":0,"dr1":0,"dr2":0,"dr3":0,"dr4":0,"dr5":0,"dr6":0,"dr7":0}},"energyStatusPeriod":0,"gpsScanMode":0,"xgpsTimeout":45,"gpsEhpe":1,"gpsConvergence":12,"bleBeaconCount":4,"bleBeaconTimeout":2,"gpsStandbyTimeout":28800,"confirmedUplink":{"framePending":false,"position":false,"energyStatus":false,"healthStatus":false,"heartbeat":false,"activityStatus":false,"configuration":false,"shockDetection":false,"shutdown":false,"event":false,"scanCollection":false,"extendedPosition":false,"debug":false,"confirmedUlBitmap":0,"confirmedUlRetry":3},"motionSensitivity":1,"shockDetection":0,"periodicActivityPeriod":0,"motionDuration":180,"geofencingScanPeriod":0,"geofencingCollectPeriod":60,"bleRssiFilter":-85,"temperatureHigh":255,"temperatureLow":255,"temperatureAction":"NO_ACTION","networkTimeoutCheck":432000,"networkTimeoutReset":172800,"collectionScanType":"NO_COLLECTION_SCAN","collectionNbEntry":20,"batteryCapacity":4294967295,"reedSwitchConfiguration":"DISABLE_REED_SWITCH","gnssConstellation":"GPS_GLONASS_GALILEO","proximityMinimumScanPower":-90,"proximityDistanceCoefficient":200,"proximityScanFrequency":1800,"proximityBacktraceMaximumAge":256,"proximityDistanceSlidingWindow":30,"proximityExposure50":200,"proximityExposure100":50,"proximityExposure150":22,"proximityExposure200":13,"proximityExposure250":0,"proximityExposure300":0,"proximityExposure400":0,"proximityImmediateAlarmDistance":0.1,"proximityAlarmExposure":12000,"proximityImmediateWarningDistance":1,"proximityWarningExposure":6000,"proximityImmediateRecordDistance":2,"proximityRecordExposure":3700,"proximityAlarmBuzzerDuration":5,"proximityWarningBuzzerDuration":5,"proximityContactPolicy":{"enable":false,"store":false,"uplink":false},"proximityScanDuration":1,"proximityScanWindow":120,"proximityScanInterval":125,"proximityAlarmRemanence":30,"proximityWarningRemanence":30,"proximityBeaconRepeat":100,"proximityBeaconTxPower":-41,"proximityReminderPeriod":20,"proximityReminderDistance":2,"proximityWarningDisableDistance":2.5,"proximityAlarmDisableDistance":2.5,"proximityMaxSpeedFilter":1.5,"proximityMaxUpdate":3600,"bleFilterType":"EDDYSTONE_UID","bleFilterMain1":0,"bleFilterMain2":0,"bleFilterSecValue":0,"bleFilterSecMask":0,"bleFilterReportType":"SHORT_ID","buzzerVolume":10,"angleDetectionMode":"DISABLED","angleReferenceAcquisition":"AUTOMATIC","angleReferenceAccelerationX":0,"angleReferenceAccelerationY":0,"angleReferenceAccelerationZ":0,"angleCritical":30,"angleCriticalHysteresis":5,"angleReportingMode":{"normalToCritical":true,"criticalToNormal":false,"learningToNormal":false,"normalToLearning":false,"criticalToLearning":false},"angleReportingPeriod":300,"angleReportingRepeat":0,"angleRisingTime":5,"angleFallingTime":5,"angleLearningTime":5,"angleAccelerationAccuracy":100,"angleDeviationDelta":0,"angleDeviationMinInterval":10,"angleDeviationMaxInterval":0,"passwordCommandLineInterface":123,"gpsT0Timeout":30,"gpsFixTimeout":0,"geofencingScanDuration":370,"beaconingType":"DISABLED","beaconingTxPower":"0_DBM","beaconingStaticInterval":10000,"beaconingMotionInterval":333,"beaconingMotionDuration":20,"bleConnectivityAdvertisingDuration":600,"beaconId0":0,"beaconId1":0,"beaconId2":0,"beaconId3":0,"beaconId4":0,"sosPeriod":120,"motionDebounce":1,"buttonMapping":{"buttonPress":"NO_ACTION","oneButtonClick":"BATTERY_LEVEL_WITH_LED","twoButtonClick":"WHITELIST_WITH_PROXIMITY","threeButtonClick":"START_STOP_SOS","buttonPressDuration":1},"defaultDatarate":2,"unknown":2,"confirmedUlBitmap":0,"confirmedUlRetry":3,"periodicPositionPeriod":3600,"gpsScanProfile":0,"collectionBLEFilterType":"NO_FILTER","collectionBLEFilterMain1":0,"collectionBLEFilterMain2":0,"collectionBLEFilterSecValue":0,"collectionBLEFilterSecMask":0},"messageSource":"LORA"}',
        group: "1736351397906",
      },
    ];
  });

  test("Check all output variables for location tracking", () => {
    eval(transpiledCode); // This runs the code and sets the payload variable

    expect(payload).toEqual(
      expect.arrayContaining([expect.objectContaining({ variable: "floor_number", value: 4 }), expect.objectContaining({ variable: "room_name", value: "443" })])
    );
  });
});
